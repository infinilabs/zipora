# Miri configuration for zipora's high-performance data structures
# Optimized for specialized hash maps, SIMD operations, and memory pools

# Core safety checks for zipora's specialized containers
flags = [
    "-Zmiri-strict-provenance",           # Essential for hash map pointer safety
    "-Zmiri-symbolic-alignment-check",    # Critical for SIMD and cache-aligned operations
    "-Zmiri-check-number-validity",       # Validate bit patterns in compressed data
    "-Zmiri-disable-isolation",           # Allow file system access for blob stores
    "-Zmiri-preemption-rate=0.01",       # Increase preemption for concurrency testing
    "-Zmiri-compare-exchange-weak-failure-rate=0.8", # Test compare-exchange failures
]

# Enhanced memory model for high-performance containers
stacked-borrows = true

# Critical for zipora's unsafe optimizations
track-raw-pointers = true

# Larger stack for complex hash map operations and deep recursion
stack-size = "4194304"  # 4MB stack for large data structure operations

# Deterministic testing for hash function validation
seed = 1618  # Golden ratio theme (φ ≈ 1.618)

# Comprehensive debugging for complex data structures
backtrace = "full"

# Memory leak detection (important for string interning and pools)
# Note: Set to false only for specific tests that intentionally leak
retag-fields = true

# Optimize for zipora's specific patterns
tag-gc = 100000  # Higher GC threshold for large collections

# Zipora-specific testing considerations:
# 
# 1. Hash Maps: The preemption rate helps catch race conditions in robin hood hashing
# 2. String Arena: Strict provenance catches string interning pointer errors  
# 3. Memory Pools: Compare-exchange failure rate tests lock-free allocation paths
# 4. SIMD Operations: Symbolic alignment check validates hardware acceleration safety
# 5. Compressed Data: Number validity check ensures bit-packed integer correctness
# 6. Large Collections: Higher stack size accommodates deep hash table operations
# 7. Golden Ratio Seed: Thematic choice (1618) for deterministic hash testing
#
# To override for specific tests, use MIRIFLAGS environment variable:
# MIRIFLAGS="-Zmiri-ignore-leaks" cargo +nightly miri test specific_test